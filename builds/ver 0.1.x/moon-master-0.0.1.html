<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon Master ‚Äî fan spoof (web)</title>
  <style>
    :root {
      --bg: #000;
      --fg: #ffffff;
      --accent: #00ff66; /* neon green */
      --accent2: #ff00aa; /* magenta */
      --accent3: #00e7ff; /* cyan */
      --accent4: #ffff55; /* yellow */
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); display: grid; place-items: center; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    #container { position: relative; }
    canvas { width: 768px; height: 576px; image-rendering: pixelated; image-rendering: crisp-edges; background: #000; border: 4px solid var(--fg); box-shadow: 0 0 0 8px rgba(255,255,255,0.08), 0 20px 60px rgba(0,0,0,0.8); border-radius: 8px; }
    #hint { position: absolute; left: 8px; right: 8px; bottom: 6px; font-size: 12px; opacity: .75; display: flex; justify-content: space-between; gap: 12px; align-items: center; pointer-events: none; }
    .btnbar { position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; }
    .btn { pointer-events: auto; background: #111; border: 1px solid #333; padding: 6px 10px; font-size: 12px; border-radius: 6px; color: #ddd; cursor: pointer; }
    .btn:hover { filter: brightness(1.2); }
    a { color: var(--accent3); text-decoration: none; }

    /* Importer panel */
    #btnImp { position: absolute; top: 8px; left: 8px; }
    .panel { position: absolute; inset: auto auto 12px 12px; width: 360px; background: rgba(0,0,0,.92); border: 1px solid #333; border-radius: 10px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,.6); }
    .panel.hidden { display: none; }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; margin: 6px 0; }
    input[type=file] { width: 100%; font-size: 11px; }
    .sub { font-size: 11px; opacity: .7; }
    label.inline { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="game" width="256" height="192"></canvas>
    <div class="btnbar">
      <button class="btn" id="btnMute" title="M">üîá Mute</button>
      <button class="btn" id="btnReset" title="R">‚Üª Reset</button>
      <button class="btn" id="btnFull" title="F">‚õ∂ Fullscreen</button>
    </div>
    <button class="btn" id="btnImp" title="I">Assets (I)</button>

    <div id="importer" class="panel hidden">
      <h3>Asset Loader</h3>
      <div class="row"><label>Player PNG <span class="sub">(~10√ó12px in-game)</span></label><input type="file" id="filePlayer" accept="image/*"></div>
      <div class="row"><label>Enemy PNG <span class="sub">(~8√ó8px)</span></label><input type="file" id="fileEnemy" accept="image/*"></div>
      <div class="row"><label>Boss PNG <span class="sub">(~60√ó30px)</span></label><input type="file" id="fileBoss" accept="image/*"></div>
      <div class="row"><label>Background Image</label><input type="file" id="fileBg" accept="image/*"></div>
      <label class="inline"><input type="checkbox" id="chkSolid"> Use near-black pixels in background as solid platforms</label>
      <div class="row"><label>Solid threshold <span class="sub">(0 = pure black)</span></label><input type="range" id="thr" min="0" max="128" value="48"></div>
      <label class="inline"><input type="checkbox" id="chkQuant" checked> Force 4‚Äëcolor look for loaded sprites</label>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button class="btn" id="btnCloseImp">Close</button>
      </div>
    </div>

    <div id="hint">
      <div>Controls: ‚Üê ‚Üí move ‚Ä¢ ‚Üë jump ‚Ä¢ X zap ‚Ä¢ Enter start ‚Ä¢ M mute ‚Ä¢ I assets</div>
      <div><small>Not affiliated with Adult Swim. Parody/fan work.</small></div>
    </div>
  </div>
  <script>
  (()=>{
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: false });
    const W = canvas.width, H = canvas.height;

    // --- Palette (4‚Äëcolor-ish vibe + black)
    const COL = { BG:'#000', INK:'#fff', G1:'#00ff66', G2:'#ff00aa', G3:'#00e7ff', Y:'#ffff55' };
    const PALETTE4 = [
      [0,0,0],         // black
      [0,30,120],      // dark blue
      [0,231,255],     // cyan
      [255,0,170]      // magenta
    ];

    // --- Resize for integer scaling
    function fit(){ const scale = Math.max(1, Math.floor(Math.min(window.innerWidth/W, window.innerHeight/H))); canvas.style.width=(W*scale)+'px'; canvas.style.height=(H*scale)+'px'; }
    window.addEventListener('resize', fit); fit();

    // --- Inputs
    const keys = new Set();
    window.addEventListener('keydown', (e)=>{ if (['ArrowLeft','ArrowRight','ArrowUp','Space','x','X','Enter','m','M','f','F','r','R','i','I','s','S'].includes(e.key)) e.preventDefault(); keys.add(e.key);});
    window.addEventListener('keyup', (e)=> keys.delete(e.key));

    // --- Audio
    let audioOn=false, ac=null; function ensureAudio(){ if(!audioOn){ ac=new (window.AudioContext||window.webkitAudioContext)(); audioOn=true; document.getElementById('btnMute').textContent='üîä Sound'; } }
    function beep(freq=440,dur=0.08,type='square',vol=0.15){ if(!audioOn||!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+dur); }

    // --- UI buttons
    document.getElementById('btnMute').onclick=()=>{ if(!audioOn){ensureAudio();return;} audioOn=false; try{ac.close();}catch{} ac=null; document.getElementById('btnMute').textContent='üîá Mute'; };
    document.getElementById('btnReset').onclick=()=>{ ensureAudio(); resetGame(); };
    document.getElementById('btnFull').onclick=()=>{ if(document.fullscreenElement) document.exitFullscreen(); else canvas.requestFullscreen().catch(()=>{}); };

    // --- Asset loader UI
    const imp = document.getElementById('importer');
    const btnImp = document.getElementById('btnImp');
    const btnCloseImp = document.getElementById('btnCloseImp');
    const chkQuant = document.getElementById('chkQuant');
    btnImp.onclick=()=>imp.classList.toggle('hidden');
    btnCloseImp.onclick=()=>imp.classList.add('hidden');
    window.addEventListener('keydown', (e)=>{ if(e.key==='i'||e.key==='I'){ imp.classList.toggle('hidden'); } });

    const assets = { player:null, enemy:null, boss:null, bg:null };
    const bgCanvas = document.createElement('canvas'); bgCanvas.width=W; bgCanvas.height=H; const bgCtx = bgCanvas.getContext('2d');
    let useSolid=false, threshold=48; let solidMask=null; // Uint8Array W*H where 1 = solid
    const chkSolid = document.getElementById('chkSolid');
    const thr = document.getElementById('thr');
    chkSolid.onchange = ()=>{ useSolid = chkSolid.checked; rebuildSolid(); };
    thr.oninput = ()=>{ threshold = +thr.value; rebuildSolid(); };

    function loadImageFromInput(input, setter){ input.addEventListener('change', ()=>{ const f=input.files&&input.files[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ const final = chkQuant.checked ? quantizeImage(img) : img; setter(final); URL.revokeObjectURL(url); }; img.src=url; }); }

    loadImageFromInput(document.getElementById('filePlayer'), (img)=> assets.player=img);
    loadImageFromInput(document.getElementById('fileEnemy'),  (img)=> assets.enemy=img);
    loadImageFromInput(document.getElementById('fileBoss'),   (img)=> assets.boss=img);
    loadImageFromInput(document.getElementById('fileBg'),     (img)=> { assets.bg=img; drawBgToCanvas(); rebuildSolid(); });

    function drawBgToCanvas(){ if(!assets.bg) return; // fit background image into W√óH while preserving aspect (contain)
      const iw=assets.bg.naturalWidth, ih=assets.bg.naturalHeight; const ar=iw/ih; const tr=W/H; let dw=W, dh=H; if(ar>tr){ dh = Math.round(W/ar); } else { dw = Math.round(H*ar); }
      bgCtx.fillStyle='#000'; bgCtx.fillRect(0,0,W,H);
      const dx=(W-dw)>>1, dy=(H-dh)>>1; bgCtx.drawImage(assets.bg, dx, dy, dw, dh);
    }

    function rebuildSolid(){ if(!assets.bg || !useSolid){ solidMask=null; return; }
      drawBgToCanvas(); const imgData = bgCtx.getImageData(0,0,W,H).data; solidMask = new Uint8Array(W*H);
      for(let i=0, p=0; i<imgData.length; i+=4, p++){
        const r=imgData[i], g=imgData[i+1], b=imgData[i+2], a=imgData[i+3];
        solidMask[p] = (a>16 && (r+g+b) <= threshold) ? 1 : 0; // near-black becomes solid
      }
      // clear HUD region
      for(let y=0; y<24; y++){ for(let x=0; x<140; x++){ solidMask[y*W+x]=0; } }
    }

    function isSolidAt(x,y){ if(!solidMask) return y>=H-12; // default: flat ground near bottom
      if(x<0||x>=W||y<0||y>=H) return true; return solidMask[(y|0)*W + (x|0)]===1;
    }

    // ---- Sprite quantizer (4‚Äëcolor look)
    function quantizeImage(img){
      const tW = Math.max(8, Math.min(64, img.naturalWidth));
      const tH = Math.max(8, Math.min(64, img.naturalHeight));
      const oc = document.createElement('canvas'); oc.width=tW; oc.height=tH; const ox=oc.getContext('2d', {willReadFrequently:true}); ox.imageSmoothingEnabled=false;
      // draw scaled down to emphasize chunky pixels
      ox.drawImage(img, 0, 0, tW, tH);
      const data = ox.getImageData(0,0,tW,tH);
      for(let i=0;i<data.data.length;i+=4){
        const a=data.data[i+3]; if(a<16){ data.data[i]=0; data.data[i+1]=0; data.data[i+2]=0; data.data[i+3]=0; continue; }
        const r=data.data[i], g=data.data[i+1], b=data.data[i+2];
        const [nr,ng,nb] = nearestInPalette(r,g,b,PALETTE4);
        data.data[i]=nr; data.data[i+1]=ng; data.data[i+2]=nb; data.data[i+3]=255;
      }
      ox.putImageData(data,0,0);
      const out = new Image(); out.src = oc.toDataURL(); return out;
    }
    function nearestInPalette(r,g,b, pal){
      let best=0, bd=1e9;
      for(let i=0;i<pal.length;i++){ const pr=pal[i][0], pg=pal[i][1], pb=pal[i][2]; const d=(r-pr)*(r-pr)+(g-pg)*(g-pg)+(b-pb)*(b-pb); if(d<bd){ bd=d; best=i; } }
      return pal[best];
    }

    // --- Stars background (fallback)
    const stars = new Array(64).fill(0).map(()=>({x: Math.random()*W, y: Math.random()*H, z: Math.random()*1}));
    function drawStars(){ ctx.fillStyle=COL.BG; ctx.fillRect(0,0,W,H); for(const s of stars){ s.x -= 0.1 + s.z*0.3; if (s.x<0){ s.x+=W; s.y=Math.random()*H; s.z=Math.random(); } ctx.fillStyle = s.z>0.66?COL.G3:(s.z>0.33?COL.G2:COL.INK); ctx.fillRect(s.x|0, s.y|0, 1, 1);} }
    function drawBackground(){ if(assets.bg){ ctx.drawImage(bgCanvas,0,0); } else { drawStars(); } }

    // --- Physics & entities
    const GRAV = 0.25;

    function rectCollides(x,y,w,h){ // any solid under rect?
      for(let yy=y|0; yy<(y+h)|0; yy++){ for(let xx=x|0; xx<(x+w)|0; xx++){ if(isSolidAt(xx,yy)) return true; } }
      return false;
    }

    // ---- Upgrades + money (score)
    let money = 0;
    const upgrades = { mult:1, triple:false, speed:false, helm:false, bossWeak:false };
    let freeHit = 0; // refreshed each level if helm purchased

    class Player {
      constructor(){ this.x=16; this.y=20; this.vx=0; this.vy=0; this.onGround=false; this.facing=1; this.cool=0; this.alive=true; this.w=8; this.h=10; this.ifr=0; }
      update(){
        const left = keys.has('ArrowLeft'); const right = keys.has('ArrowRight'); const jump = keys.has('ArrowUp'); const shoot = keys.has('x')||keys.has('X');
        const accel = upgrades.speed?0.35:0.25; const maxv = upgrades.speed?1.6:1.2;
        if (left)  { this.vx=Math.max(this.vx-accel,-maxv); this.facing=-1; }
        if (right) { this.vx=Math.min(this.vx+accel, maxv); this.facing=1; }
        if (!left && !right) this.vx *= 0.8;
        if (jump && this.onGround) { this.vy = upgrades.speed?-3.6:-3.2; this.onGround=false; beep(220,0.06,'square',0.12); }
        if (shoot && this.cool<=0) {
          shots.push(new Shot(this.x+6*this.facing, this.y+this.h-6, this.facing, 0));
          if (upgrades.triple){ shots.push(new Shot(this.x+6*this.facing, this.y+this.h-7, this.facing, -0.2)); shots.push(new Shot(this.x+6*this.facing, this.y+this.h-5, this.facing, 0.2)); }
          this.cool = upgrades.triple?7:10; beep(880,0.05,'square',0.08);
        }
        if(this.cool>0) this.cool--;
        if(this.ifr>0) this.ifr--;
        // Apply gravity
        this.vy += GRAV;
        // Horizontal step & collide
        this.x += this.vx; if (rectCollides(this.x, this.y, this.w, this.h)) { while(rectCollides(this.x, this.y, this.w, this.h)) this.x -= Math.sign(this.vx||1); this.vx=0; }
        // Vertical step & collide
        this.y += this.vy; if (rectCollides(this.x, this.y, this.w, this.h)) { const dir=Math.sign(this.vy||1); while(rectCollides(this.x, this.y, this.w, this.h)) this.y -= dir; if (dir>0){ this.onGround=true; } this.vy=0; } else { this.onGround=false; }
        // Bounds
        if (this.x<1){ this.x=1; this.vx=0; } if(this.x>W-this.w-1){ this.x=W-this.w-1; this.vx=0; }
      }
      draw(){
        if (assets.player) { ctx.imageSmoothingEnabled=false; ctx.drawImage(assets.player, this.x|0, (this.y|0)-2, 10, 12); return; }
        ctx.fillStyle = COL.G1; ctx.fillRect(this.x|0, (this.y-10)|0, 8, 10);
        ctx.fillStyle = COL.G3; ctx.fillRect((this.x+2)|0, (this.y-8)|0, 4, 3);
        ctx.fillStyle = COL.G2; ctx.fillRect(this.x|0, this.y|0, 3, 2); ctx.fillRect((this.x+5)|0, this.y|0, 3, 2);
      }
      hurt(){ if(this.ifr>0) return; if (freeHit>0){ freeHit--; beep(240,0.05,'square',0.12); this.ifr=30; return; } this.ifr=30; this.vx += -this.facing*1.2; this.vy = -1.5; money = Math.max(0, Math.floor(money - 10)); beep(120,0.1,'square',0.2); }
    }

    class Shot { constructor(x,y,dir,vy){ this.x=x; this.y=y; this.vx=dir*2.2*(upgrades.speed?1.2:1); this.vy=vy||0; this.dead=false; }
      update(){ this.x += this.vx; this.y += this.vy; if (this.x<0||this.x>W||isSolidAt(this.x|0, this.y|0)) this.dead=true; }
      draw(){ ctx.fillStyle = COL.Y; ctx.fillRect(this.x|0, this.y|0, 3, 1); }
    }

    class Enemy { constructor(x){ this.x=x; this.y=10; this.vx=0.5*(Math.random()<0.5?-1:1); this.dead=false; this.w=8; this.h=8; }
      update(){
        this.vy = (this.vy||0) + GRAV; this.x += this.vx; if (rectCollides(this.x, this.y, this.w, this.h)) { while(rectCollides(this.x, this.y, this.w, this.h)) this.x -= Math.sign(this.vx); this.vx*=-1; }
        this.y += this.vy; if (rectCollides(this.x, this.y, this.w, this.h)) { while(rectCollides(this.x, this.y, this.w, this.h)) this.y -= Math.sign(this.vy); this.vy=0; }
        const aheadX = this.x + (this.vx>0?this.w+1:-1); const footY = this.y + this.h + 1; if (!isSolidAt(aheadX|0, footY|0)) this.vx *= -1;
        // collide with player
        if (!this.dead && Math.abs((this.x+this.w/2) - (player.x+player.w/2))<6 && Math.abs((this.y+this.h/2) - (player.y+player.h/2))<6){ player.hurt(); }
      }
      draw(){ if (assets.enemy) { ctx.drawImage(assets.enemy, (this.x|0), (this.y|0)-2, 8, 10); return; } ctx.fillStyle = COL.G2; ctx.fillRect((this.x|0), (this.y|0), 8, 8); }
    }

    class Coin { constructor(x,y){ this.x=x; this.y=y; this.t=0; this.dead=false; }
      update(){ this.t++; if (Math.abs(this.x - (player.x+4))<6 && Math.abs(this.y - (player.y+5))<6){ this.dead=true; const earn = Math.floor(5*upgrades.mult); money += earn; beep(600,0.05,'square',0.12); } }
      draw(){ ctx.fillStyle = COL.Y; ctx.fillRect((this.x|0)-1, (this.y|0)-1, 3,3); }
    }

    class Gorgotron { constructor(){ this.x=W-88; this.y=20; this.hp=upgrades.bossWeak?1:3; this.dead=false; this.tick=0; this.w=60; this.h=30; }
      update(){ this.tick++; if (this.tick%120===0) beep(110,0.1,'square',0.2);
        this.vy = (this.vy||0) + GRAV; this.y += this.vy; if (rectCollides(this.x, this.y, this.w, this.h)) { while(rectCollides(this.x, this.y, this.w, this.h)) this.y -= Math.sign(this.vy); this.vy=0; }
        if (!this.dead && Math.abs((this.x+this.w/2) - (player.x+player.w/2))<16 && Math.abs((this.y+this.h/2) - (player.y+player.h/2))<12){ player.hurt(); }
      }
      hit(){ if (!this.dead) { this.hp--; if (this.hp<=0) { this.dead=true; for (let i=0;i<10;i++) particles.push(new Particle(this.x+Math.random()*this.w, this.y+Math.random()*this.h)); beep(60,0.25,'sawtooth',0.2);} } }
      draw(){ if (this.dead) return; if (assets.boss) { ctx.drawImage(assets.boss, this.x|0, this.y|0, this.w, this.h); return; } ctx.fillStyle = COL.G2; ctx.fillRect(this.x|0, this.y|0, this.w, this.h); ctx.fillStyle=COL.G3; ctx.fillRect((this.x+20)|0, (this.y+6)|0, 20, 6); }
    }

    class Particle { constructor(x,y){ this.x=x; this.y=y; this.vx=(Math.random()*2-1); this.vy=(Math.random()*-1.5-0.5); this.t=60; }
      update(){ this.t--; this.x+=this.vx; this.y+=this.vy; this.vy+=0.05; }
      draw(){ if (this.t<=0) return; ctx.fillStyle = COL.Y; ctx.fillRect(this.x|0, this.y|0, 1,1); }
    }

    let player, shots, enemies, boss, particles, coins;

    // --- State
    let state='TITLE'; let level=1; let goalX=W-24; let msgTimer=0;

    // Procedural level params
    function levelParams(n){ return { enemyCount: Math.min(6, Math.floor(1+n*0.4)), coinCount: Math.min(20, 6+Math.floor(n*0.6)) }; }

    function resetLevel(){
      player = new Player(); player.y = 8; freeHit = upgrades.helm?1:0;
      shots = []; particles = []; coins = [];
      const p = levelParams(level);
      enemies = (state==='BOSS') ? [] : new Array(p.enemyCount).fill(0).map((_,i)=> new Enemy(30 + Math.random()*(W-80)));
      for(let i=0;i<p.coinCount;i++){ coins.push(new Coin(20+Math.random()*(W-40), 24+Math.random()*(H-60))); }
      boss = (state==='BOSS') ? new Gorgotron() : null;
      msgTimer = 60;
    }
    function resetGame(){ level=1; money=0; state='TITLE'; resetLevel(); }

    // --- UI
    function drawUIBar(){ ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,W,12); ctx.fillStyle=COL.INK; ctx.fillText(`LV ${level}  $ ${money}  ${(upgrades.helm?'ü™ñ':'')} ${(upgrades.triple?'‚á∂':'')} ${(upgrades.speed?'‚ö°':'')}`, 4, 9); }

    function loop(){ requestAnimationFrame(loop); drawBackground(); if (state==='TITLE') return drawTitle(); if (state==='SHOP') return drawShop(); if (state==='ENDING') return drawEnding(); if (state==='PLAY') return drawPlay(); if (state==='BOSS') return drawBoss(); }

    function drawPlay(){ drawUIBar();
      // beacon goal
      ctx.fillStyle = COL.G3; ctx.fillRect(goalX, 12, 6, H-24); ctx.fillStyle = COL.Y; ctx.fillRect(goalX-4, 12, 10, 3);
      player.update();
      // victory line
      if (player.x>goalX-1) {
        const reward = Math.floor((25 + level) * upgrades.mult);
        money += reward;
        level++;
        state = (level%50===0)?'BOSS':'SHOP';
        ensureAudio(); beep(520,0.08); beep(660,0.08);
        resetLevel();
        return;
      }
      enemies.forEach(e=>e.update()); shots.forEach(s=>s.update()); coins.forEach(c=>c.update());
      // shot-enemy collisions
      shots.forEach(s=>{ enemies.forEach(e=>{ if (!e.dead && Math.abs(s.x - (e.x+e.w/2)) < 6 && Math.abs(s.y - (e.y+e.h/2)) < 6) { e.dead=true; s.dead=true; particles.push(new Particle(e.x, e.y)); const earn=Math.floor(5*upgrades.mult); money+=earn; beep(300,0.06); } }); });
      enemies = enemies.filter(e=>!e.dead); shots = shots.filter(s=>!s.dead); coins = coins.filter(c=>!c.dead);
      enemies.forEach(e=>e.draw()); shots.forEach(s=>s.draw()); coins.forEach(c=>c.draw()); player.draw(); particles.forEach(p=>p.update()); particles.forEach(p=>p.draw()); particles = particles.filter(p=>p.t>0);
      if (msgTimer>0) { msgTimer--; ctx.fillStyle = COL.INK; ctx.fillText('WALK RIGHT ‚Ä¢ COLLECT $ ‚Ä¢ AVOID HUGS', 52, 20); }
    }

    function drawBoss(){ drawUIBar(); ctx.fillStyle = COL.INK; ctx.fillText('GORGOTRON APPROACHES', 78, 20);
      player.update(); if (!boss) boss = new Gorgotron(); boss.update();
      shots.forEach(s=>{ s.update(); if (!boss.dead && s.x>boss.x && s.x<boss.x+boss.w && s.y>boss.y && s.y<boss.y+boss.h) { boss.hit(); s.dead=true; const earn=Math.floor(10*upgrades.mult); money+=earn; } }); shots = shots.filter(s=>!s.dead);
      boss.draw(); shots.forEach(s=>s.draw()); player.draw(); particles.forEach(p=>p.update()); particles.forEach(p=>p.draw()); particles = particles.filter(p=>p.t>0);
      if (boss.dead) { ctx.fillStyle = COL.Y; ctx.fillText('YOU WIN. (OF COURSE.)', 86, 40); if (msgTimer--<=0) { level++; state='SHOP'; resetLevel(); } }
    }

    function drawTitle(){ ctx.fillStyle = COL.INK; ctx.font = 'bold 12px monospace'; ctx.fillText('MOON MASTER', 84, 50); ctx.font = '8px monospace'; ctx.fillStyle = COL.G1; ctx.fillText('An intentionally easy, scam-flavored spoof.', 38, 68); ctx.fillStyle = COL.G3; ctx.fillText('Press Enter or Click to Begin', 60, 86); ctx.fillStyle = COL.INK; ctx.fillText('Controls: ‚Üê ‚Üí move  ‚Üë jump  X zap  (M mute, F fullscreen, R reset, I assets)', 8, 104); ctx.fillStyle = COL.G2; ctx.fillText('Infinite run. Boss every 50 levels. $ = score for merch/power-ups.', 18, 122);
      ctx.fillStyle = COL.G2; ctx.fillRect(W-28, 12, 6, H-24); ctx.fillStyle = COL.Y; ctx.fillRect(W-32, 12, 10, 3); const demo = new Player(); demo.x = 30; demo.draw(); if (keys.has('Enter')) { ensureAudio(); state='PLAY'; resetLevel(); } }

    // --- Shop (merch = upgrades)
    const shopCatalog = [
      {id:'mult1', name:'Certificate of Mastery', price: 50, desc:'+20% payouts (stackable)', onBuy: ()=>{ upgrades.mult = Math.round((upgrades.mult+0.2)*100)/100; }},
      {id:'triple', name:'Moon Blaster Mk.III', price: 120, desc:'Triple-shot forever', onBuy: ()=>{ upgrades.triple=true; }},
      {id:'boots', name:'Zero‚ÄëG Boots', price: 90, desc:'Faster run & jump', onBuy: ()=>{ upgrades.speed=true; }},
      {id:'helm', name:'Official Helmet', price: 80, desc:'One free hit each level', onBuy: ()=>{ upgrades.helm=true; }},
      {id:'repel', name:'Gorgotron Repellent', price: 300, desc:'Boss is weak (1 HP)', onBuy: ()=>{ upgrades.bossWeak=true; }},
    ];
    const owned = new Set();
    let shopFlash=0; let lastClickMsg='';
    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect(); const scale = parseInt(canvas.style.width) / W || 1; const mx = (e.clientX - rect.left) / scale; const my = (e.clientY - rect.top) / scale;
      if (state==='TITLE') { ensureAudio(); state='PLAY'; resetLevel(); return; }
      if (state==='SHOP') {
        // continue button
        if (mx>20 && mx<120 && my>H-30 && my<H-16) { state=(level%50===0)?'BOSS':'PLAY'; resetLevel(); return; }
        // buy rows
        const startY = 50;
        shopCatalog.forEach((it, idx)=>{
          const y = startY + idx*18;
          if (mx>16 && mx<W-16 && my>y-10 && my<y+6) {
            ensureAudio();
            if(owned.has(it.id) && it.id!=='mult1'){ lastClickMsg = `${it.name}: already owned.`; beep(120,0.08,'square',0.12); return; }
            if(money < it.price){ lastClickMsg = `Not enough $. ${it.name} costs $${it.price}`; beep(120,0.08,'square',0.12); return; }
            money -= it.price; it.onBuy(); owned.add(it.id); shopFlash=6; lastClickMsg = `Purchased: ${it.name}`; beep(660,0.05,'square',0.15);
          }
        });
      }
    });

    function drawShop(){ drawUIBar();
      ctx.fillStyle = COL.INK; ctx.font = 'bold 10px monospace'; ctx.fillText('WELCOME, MOON MASTER. SPEND YOUR HARD‚ÄëEARNED $.', 12, 24);
      ctx.font = '8px monospace'; ctx.fillStyle = COL.G3; ctx.fillText('Merch doubles as power‚Äëups. No refunds. Probably a scam.', 16, 36);
      const startY = 50;
      shopCatalog.forEach((it, idx)=>{
        const y = startY + idx*18;
        const ownedFlag = owned.has(it.id) && it.id!=='mult1';
        if (shopFlash>0) ctx.fillStyle = (shopFlash%2?COL.Y:COL.INK); else ctx.fillStyle=COL.INK;
        ctx.fillText(`${it.name} ‚Äî ${it.desc}`, 16, y);
        ctx.fillStyle = ownedFlag? '#777' : COL.G2; ctx.fillText(`${ownedFlag?'OWNED':('$'+it.price+' [CLICK]')}`, 190, y);
      });
      if (shopFlash>0) shopFlash--;
      // continue button
      ctx.fillStyle = COL.G2; ctx.fillRect(20, H-30, 100, 14); ctx.fillStyle = COL.BG; ctx.fillText('CONTINUE ‚Üí', 40, H-19);
      // bottom message
      ctx.fillStyle = COL.G1; ctx.fillText(lastClickMsg || 'Tip: multipliers stack. Boss appears at L50, L100, ...', 12, H-6);
      if (keys.has('Enter')) { state=(level%50===0)?'BOSS':'PLAY'; resetLevel(); }
    }

    function drawEnding(){ drawUIBar(); ctx.fillStyle = COL.INK; ctx.font = 'bold 10px monospace'; ctx.fillText('THE GORGOTRON HAS BEEN DEFEATED.', 44, 48); ctx.font = '8px monospace'; ctx.fillStyle = COL.G3; ctx.fillText('The Moon is safe.*', 96, 64); ctx.fillStyle = COL.G2; ctx.fillText('*Probably. Results may vary upon return to lunar surface.', 20, 78); ctx.fillStyle = COL.INK; ctx.fillText('Press R to reset or F for fullscreen.', 62, 96); if (keys.has('r') || keys.has('R')) resetGame(); }

    // Boot
    ctx.imageSmoothingEnabled=false; ctx.font='8px monospace'; resetGame(); requestAnimationFrame(loop);

    window.addEventListener('keydown', (e)=>{ if (e.key==='Enter') ensureAudio(); if (e.key==='M'||e.key==='m'){ if(!audioOn) ensureAudio(); else { audioOn=false; try{ac.close();}catch{}; ac=null; document.getElementById('btnMute').textContent='üîá Mute'; } } if (e.key==='F'||e.key==='f'){ if(document.fullscreenElement) document.exitFullscreen(); else canvas.requestFullscreen().catch(()=>{}); } if (e.key==='R'||e.key==='r'){ ensureAudio(); resetGame(); } });
  })();
  </script>
</body>
</html>
